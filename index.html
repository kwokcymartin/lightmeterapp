<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>iPad Light Meter</title>
  <style>
    :root{
      --text-color:#fff;
      --accent:#0A84FF;
      --panel:rgba(28,28,30,0.85);
    }
    body{
      margin:0;
      height:100vh;
      overflow:hidden;
      background:#000;
      color:var(--text-color);
      font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      -webkit-font-smoothing:antialiased;
    }

    /* Live video background (front camera mirrored like selfie) */
    #videoSource{
      position:fixed;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      z-index:-2;
      transform:scaleX(-1);
    }
    .video-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.6);
      z-index:-1;
    }

    /* Canvas can be hidden (it still works because the video is visible/rendered) */
    #analysisCanvas{
      position:absolute;
      top:-9999px;
      left:-9999px;
      width:1px;
      height:1px;
      opacity:0;
      pointer-events:none;
    }

    #startBtn{
      background:var(--accent);
      color:#fff;
      border:0;
      padding:15px 40px;
      font-size:18px;
      border-radius:30px;
      font-weight:600;
      cursor:pointer;
      z-index:10;
    }
    #startBtn:active{ opacity:0.75; }

    .hidden{ display:none !important; }

    .meter-display{
      text-align:center;
      margin-bottom:24px;
      text-shadow:0 2px 10px rgba(0,0,0,0.55);
    }
    .label{
      font-size:14px;
      text-transform:uppercase;
      letter-spacing:1px;
      color:rgba(255,255,255,0.8);
      margin-bottom:6px;
    }
    .main-value{
      font-size:72px;
      font-weight:200;
      font-variant-numeric:tabular-nums;
      line-height:1;
    }
    .unit{
      font-size:22px;
      color:rgba(255,255,255,0.6);
      margin-left:8px;
      font-weight:400;
    }

    .controls{
      width:85%;
      max-width:520px;
      background:var(--panel);
      backdrop-filter:blur(18px);
      -webkit-backdrop-filter:blur(18px);
      border:1px solid rgba(255,255,255,0.10);
      border-radius:18px;
      box-shadow:0 4px 20px rgba(0,0,0,0.5);
      padding:18px 18px 22px 18px;
      position:relative;
      overflow:hidden;
    }

    .hint{
      font-size:12px;
      color:#b7b7b7;
      line-height:1.35;
    }

    /* 5-second progress bar */
    .timer-bar{
      width:0%;
      height:2px;
      background:var(--accent);
      position:absolute;
      bottom:0;
      left:0;
      transition:width 5s linear;
    }

    .status{
      font-size:12px;
      color:rgba(255,255,255,0.65);
      margin-top:16px;
      z-index:10;
      text-shadow:0 2px 10px rgba(0,0,0,0.55);
    }
  </style>
</head>
<body>

  <video id="videoSource" playsinline autoplay muted></video>
  <div class="video-overlay"></div>

  <canvas id="analysisCanvas"></canvas>

  <button id="startBtn">Start Light Meter</button>

  <div id="interface" class="hidden">
    <div class="meter-display">
      <div class="label">Illuminance</div>
      <div class="main-value">
        <span id="luxVal">0</span><span class="unit">unit</span>
      </div>
    </div>

    <div class="controls">
      <div class="hint">Updates every 5 seconds. Point the camera at the scene you want to measure.</div>
      <div id="timerBar" class="timer-bar"></div>
    </div>
  </div>

  <div class="status" id="statusText">Camera access required</div>

  <script>
    const video = document.getElementById('videoSource');
    const canvas = document.getElementById('analysisCanvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });

    const startBtn = document.getElementById('startBtn');
    const ui = document.getElementById('interface');
    const statusText = document.getElementById('statusText');

    const luxDisplay = document.getElementById('luxVal');
    const timerBar = document.getElementById('timerBar');

    // Settings
    const PROCESS_INTERVAL = 5000; // 5 seconds
    const CANVAS_SIZE = 64;

    // Keep calibration fixed (slider removed)
    const calibrationFactor = 1.0;

    let intervalId = null;

    startBtn.addEventListener('click', async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: 'user',        // front camera
            width: { ideal: 640 },
            height: { ideal: 480 }
          },
          audio: false
        });

        video.srcObject = stream;

        video.onloadedmetadata = async () => {
          // Some iOS/Safari builds behave better if play() is called explicitly
          try { await video.play(); } catch (e) {}

          startBtn.classList.add('hidden');
          ui.classList.remove('hidden');
          statusText.textContent = '';

          canvas.width = CANVAS_SIZE;
          canvas.height = CANVAS_SIZE;

          // Update immediately, then every 5 seconds
          analyzeFrame();
          if (intervalId) clearInterval(intervalId);
          intervalId = setInterval(analyzeFrame, PROCESS_INTERVAL);

          // Start the progress bar
          restartTimerBar();
        };

      } catch (err) {
        statusText.textContent = "Error: " + err.message;
        alert("Could not access camera. Make sure you're on HTTPS and camera permission is allowed.");
      }
    });

    function restartTimerBar() {
      timerBar.style.transition = 'none';
      timerBar.style.width = '0%';
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          timerBar.style.transition = `width ${PROCESS_INTERVAL}ms linear`;
          timerBar.style.width = '100%';
        });
      });
    }

    function analyzeFrame() {
      if (video.readyState >= video.HAVE_ENOUGH_DATA) {
        ctx.drawImage(video, 0, 0, CANVAS_SIZE, CANVAS_SIZE);

        const frame = ctx.getImageData(0, 0, CANVAS_SIZE, CANVAS_SIZE);
        const data = frame.data;

        let totalLuminance = 0;
        const pixelCount = data.length / 4;

        for (let i = 0; i < data.length; i += 4) {
          const r = data[i];
          const g = data[i + 1];
          const b = data[i + 2];

          // luminance = 0.2126*R + 0.7152*G + 0.0722*B
          totalLuminance += (0.2126 * r) + (0.7152 * g) + (0.0722 * b);
        }

        const avgLuminance = totalLuminance / pixelCount; // 0..255

        // Approximate lux mapping (still relative due to camera auto-exposure)
        let rawLux = (avgLuminance / 255) * 500;
        rawLux = Math.pow(rawLux, 1.5);
        const finalLux = rawLux * calibrationFactor * 10;

        // Nearest hundreds
        const luxRounded = Math.round(finalLux / 100) * 100;
        luxDisplay.textContent = luxRounded;

        // restart 5s progress indicator each reading
        restartTimerBar();
      }
    }
  </script>
</body>
</html>
